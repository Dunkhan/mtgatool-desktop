name: "Release"

on:
  push:
    tags: 'v*'
    branches:
      - "dev"

jobs:
  build-job:
    runs-on: ${{ matrix.os }}
    name: "Release (${{ matrix.os }})"
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-11]

    steps:
    - name: "Setup node"
      uses: actions/setup-node@v1
      with:
        node-version: '16'
    - name: "Checkout source code"
      uses: "actions/checkout@v2"
    - name: "Install modules"
      run: "npm run install:ci"
    - name: "Test"
      run: "npm run jest:ci"
    - name: "Generate build information json"
      run: "node generateInfo.js"
    - name: "Build release, create GitHub release and upload assets (electron-builder)"
      run: "npm run release"
      env:
        GH_TOKEN: ${{ github.token }}
        # create release if it doesn't exist
        CI_BUILD_TAG: 1
    - name: "Print dist dir"
      run: "ls dist/"
    - name: Upload dist as artifact
      uses: actions/upload-artifact@v2
      with:
        name: release-${{ matrix.os }}
        path: |
          dist/*
          !dist/*/**
